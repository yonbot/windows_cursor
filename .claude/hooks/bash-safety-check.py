#!/usr/bin/env python3

import json
import sys
import re
from datetime import datetime

def log_event(event_type, command, action=""):
    """ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²"""
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    log_file = os.path.expanduser("~/.claude_safety_hooks.log")
    with open(log_file, 'a') as f:
        f.write(f"[{timestamp}] {event_type}: {command} {action}\n")

def check_dangerous_command(command):
    """å±é™ºãªã‚³ãƒãƒ³ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯"""
    
    # rm -rf ãƒ‘ã‚¿ãƒ¼ãƒ³
    if re.search(r'rm\s+(-\w*r\w*f|-\w*f\w*r)', command):
        print("""
ğŸš¨ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   å±é™ºãªã‚³ãƒãƒ³ãƒ‰ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼
ğŸš¨ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸  ã‚³ãƒãƒ³ãƒ‰: {}
ğŸ’€ å±é™ºåº¦: é«˜ï¼ˆå®Œå…¨å‰Šé™¤ãƒ»å¾©å…ƒä¸å¯èƒ½ï¼‰

âœ… ä»£æ›¿æ¡ˆ:
   1. gomiã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ï¼ˆå¾©å…ƒå¯èƒ½ï¼‰: {}
   
   2. ã‚ˆã‚Šæ…é‡ãªå‰Šé™¤:
      - ã¾ãšlsã§ç¢ºèª
      - æ®µéšçš„ã«å‰Šé™¤ï¼ˆrm -r without -fï¼‰

âŒ ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
""".format(command, re.sub(r'rm\s+-rf', 'gomi', command)), file=sys.stderr)
        return False
    
    # sudo rm ãƒ‘ã‚¿ãƒ¼ãƒ³
    if re.search(r'sudo\s+rm\s+', command):
        print("""
ğŸš¨ ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã®å‰Šé™¤ã‚³ãƒãƒ³ãƒ‰ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸  ã‚³ãƒãƒ³ãƒ‰: {}
ğŸ”’ æ¨©é™: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…

âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚
""".format(command), file=sys.stderr)
        return False
    
    # curl/wget | bash/sh ãƒ‘ã‚¿ãƒ¼ãƒ³
    if re.search(r'(curl|wget)\s+.*\|\s*(bash|sh)', command):
        print("""
ğŸš¨ æœªæ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸  ã‚³ãƒãƒ³ãƒ‰: {}
ğŸ” ãƒªã‚¹ã‚¯: æœªæ¤œè¨¼ã®ã‚³ãƒ¼ãƒ‰ã‚’ç›´æ¥å®Ÿè¡Œ

âœ… æ¨å¥¨æ‰‹é †:
   1. ã¾ãšã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
   2. å†…å®¹ã‚’ç¢ºèª
   3. å®‰å…¨æ€§ã‚’æ¤œè¨¼å¾Œã«å®Ÿè¡Œ

âŒ ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚
""".format(command), file=sys.stderr)
        return False
    
    # ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®å‰Šé™¤æ“ä½œ
    if re.search(r'rm\s+.*(/\s|/bin|/etc|/usr|/var|/System|/Library)', command):
        print("""
ğŸš¨ ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®æ“ä½œãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â›” çµ¶å¯¾ã«å®Ÿè¡Œã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ï¼
ğŸ’€ ã‚³ãƒãƒ³ãƒ‰: {}

âŒ ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚
""".format(command), file=sys.stderr)
        return False
    
    # chmod 777 (è­¦å‘Šã®ã¿)
    if re.search(r'chmod\s+777', command):
        print("""
âš ï¸  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã®ã‚ã‚‹ã‚³ãƒãƒ³ãƒ‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”“ ã‚³ãƒãƒ³ãƒ‰: {}
ğŸš¨ ãƒªã‚¹ã‚¯: å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¨æ¨©é™ã‚’ä»˜ä¸

ğŸ’¡ æ¨å¥¨ã•ã‚Œã‚‹ä»£æ›¿æ¡ˆ:
   - chmod 755 (å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«)
   - chmod 644 (é€šå¸¸ã®ãƒ•ã‚¡ã‚¤ãƒ«)
   - chmod 600 (æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«)

âš ï¸  æ³¨æ„ã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
""".format(command), file=sys.stderr)
        # è­¦å‘Šã®ã¿ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
        return True
    
    return True

def main():
    # æ¨™æº–å…¥åŠ›ã‹ã‚‰JSONã‚’èª­ã¿è¾¼ã‚€
    try:
        data = json.load(sys.stdin)
        
        # Bashã‚³ãƒãƒ³ãƒ‰ã‚’å–å¾—
        command = data.get('params', {}).get('command', '')
        
        # å±é™ºãªã‚³ãƒãƒ³ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
        if not check_dangerous_command(command):
            # å±é™ºãªã‚³ãƒãƒ³ãƒ‰ã¯ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆexit code 2ï¼‰
            sys.exit(2)
        
        # å®‰å…¨ãªã‚³ãƒãƒ³ãƒ‰ã¯é€šé
        sys.exit(0)
        
    except Exception as e:
        print(f"Error in safety check: {e}", file=sys.stderr)
        # ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å®‰å…¨ã®ãŸã‚é€šéã•ã›ã‚‹
        sys.exit(0)

if __name__ == "__main__":
    import os
    main()